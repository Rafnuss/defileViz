import { createI18n } from "vue-i18n";

// Supported locales
export const LANGUAGE_OPTIONS = [
  { code: "en", flag: "üá∫üá∏", name: "English", shortName: "EN" },
  { code: "fr", flag: "üá´üá∑", name: "Fran√ßais", shortName: "FR" },
  { code: "de", flag: "üá©üá™", name: "Deutsch", shortName: "DE" },
];

// Translation messages
const messages = {
  en: {
    nav: {
      title: "Defile Bird Forecasts",

      settings: "Settings",
    },
    intro: {
      title: "Welcome to Defile Bird Forecasts",
      description:
        "This website provides daily migration forecasts for the count of raptor species at the D√©fil√© de l'Ecluse, based on a",
      neuralNetwork: "neural network model",
      checkActualCount: "Check out the actual count on",
      readMore: "and read more about this history of this project (in French) on the website of",
    },
    table: {
      title: "Today's Predictions by Species",
      species: "Species",
      observed: "Observed",
      counted: "Counted",
      predicted: "Predicted",
      historical: "Historical Median",
      quantile: "Quantile",
      explanation: {
        title: "Table columns explained",
        species: "Bird species name",
        observed: "Observed total so far species (live data if available)",
        predicted: "Predicted total number of individuals expected species (from 6am to 7pm)",
        quantile:
          "How species's prediction compares to past years (e.g., 90th means higher than 90% of previous years for this date)",
        historicalMedian: "Typical (median) count for this date in past years",
      },
    },
    plots: {
      hourlyPrediction: "Hourly Prediction",
      expandAll: "Expand All",
      collapseAll: "Collapse All",
      today: "Today",
      nextDays: "Next Days",
      season: "This season...",
      species: "Species",
      noForecastData: "No forecast data available",
      predictedTotal: "Predicted Total",
      observedTotal: "Observed Total",
      quantileRange: "20-80% Quantile",
      median: "Median",
      dailyCount: "Daily Count",
      date: "Date",
      hour: "Hour",
      forecast: "Forecast",
      trektellenObservations: "Trektellen Observations",
      forecastedCounts: "Forecasted individual counts (#)",
      historicalCounts: "Historical counts (#)",
      birds: "birds",
      futureDays: "Future Days (hourly sequence)",
      hourlyForecastCount: "Hourly forecast count",
    },
    settings: {
      title: "Settings",
      plotsToDisplay: "Plots to display",
      today: "Today",
      nextDays: "Next Days",
      season: "Season",
      threshold: "Historical median count threshold",
      thresholdHelp:
        "Only species with a higher historical median daily count for the day will be displayed",
      nextDaysCount: "Number of next days to display",
      nextDaysHelp: 'Number of days after today to show in the "Next Days" forecast',
      sortBy: "Sort species by",
      taxonomy: "Taxonomy",
      median: "Median count",
      predicted: "Predicted count",
      quantile: "Quantile predicted",
    },
    weather: {
      title: "Weather Forecast",
      variable: "Variable:",
      days: "Days:",
    },
    common: {
      loading: "Loading",
      previousDay: "Previous day",
      nextDay: "Next day",
      today: "Today",
      close: "Close",
    },
    species: {
      "Common Buzzard": "Common Buzzard",
      "Red Kite": "Red Kite",
      "Black Kite": "Black Kite",
      "European Honey-buzzard": "European Honey-buzzard",
      "Western Marsh Harrier": "Western Marsh Harrier",
      "Eurasian Sparrowhawk": "Eurasian Sparrowhawk",
      "Eurasian Kestrel": "Eurasian Kestrel",
      "Osprey": "Osprey",
      "Hen Harrier": "Hen Harrier",
      "Merlin": "Merlin",
      "Eurasian Hobby": "Eurasian Hobby",
    },
  },
  fr: {
    nav: {
      title: "Pr√©visions d'Oiseaux du D√©fil√©",
      settings: "Param√®tres",
    },
    intro: {
      title: "Bienvenue aux Pr√©visions d'Oiseaux du D√©fil√©",
      description:
        "Ce site web fournit des pr√©visions quotidiennes de migration pour le comptage des esp√®ces de rapaces au D√©fil√© de l'Ecluse, bas√©es sur un",
      neuralNetwork: "mod√®le de r√©seau neuronal",
      checkActualCount: "Consultez le comptage r√©el sur",
      readMore: "et lisez-en plus sur l'histoire de ce projet sur le site web de",
    },
    table: {
      title: "Pr√©visions d'Aujourd'hui par Esp√®ce",
      species: "Esp√®ces",
      observed: "Observ√©",
      counted: "Compt√©es",
      predicted: "Pr√©dites",
      historical: "M√©diane Historique",
      quantile: "Quantile",
      explanation: {
        title: "Explication des colonnes du tableau",
        species: "Nom de l'esp√®ce d'oiseau",
        observed: "Total observ√© jusqu'√† pr√©sent pour l'esp√®ce (donn√©es en direct si disponibles)",
        predicted: "Nombre total pr√©dit d'individus attendus pour l'esp√®ce (de 6h √† 19h)",
        quantile:
          "Comment la pr√©diction de l'esp√®ce se compare aux ann√©es pass√©es (ex: 90e signifie plus √©lev√© que 90% des ann√©es pr√©c√©dentes pour cette date)",
        historicalMedian: "Comptage typique (m√©dian) pour cette date dans les ann√©es pass√©es",
      },
    },
    plots: {
      hourlyPrediction: "Pr√©vision Horaire",
      expandAll: "Tout D√©velopper",
      collapseAll: "Tout R√©duire",
      today: "Aujourd'hui",
      nextDays: "Prochains Jours",
      season: "Cette saison...",
      species: "Esp√®ces",
      noForecastData: "Aucune donn√©e de pr√©vision disponible",
      predictedTotal: "Total Pr√©dit",
      observedTotal: "Total Observ√©",
      quantileRange: "Quantile 20-80%",
      median: "M√©diane",
      dailyCount: "Comptage Quotidien",
      date: "Date",
      hour: "Heure",
      forecast: "Pr√©vision",
      trektellenObservations: "Observations Trektellen",
      forecastedCounts: "Comptes individuels pr√©dits (#)",
      historicalCounts: "Comptes historiques (#)",
      birds: "oiseaux",
      futureDays: "Jours futurs (s√©quence horaire)",
      hourlyForecastCount: "Comptage pr√©visionnel horaire",
    },
    settings: {
      title: "Param√®tres",
      plotsToDisplay: "Graphiques √† afficher",
      today: "Aujourd'hui",
      nextDays: "Prochains Jours",
      season: "Saison",
      threshold: "Seuil de comptage m√©dian historique",
      thresholdHelp:
        "Seules les esp√®ces avec un comptage quotidien m√©dian historique plus √©lev√© pour le jour seront affich√©es",
      nextDaysCount: "Nombre de prochains jours √† afficher",
      nextDaysHelp:
        'Nombre de jours apr√®s aujourd\'hui √† montrer dans la pr√©vision "Prochains Jours"',
      sortBy: "Trier les esp√®ces par",
      taxonomy: "Taxonomie",
      median: "Comptage m√©dian",
      predicted: "Comptage pr√©dit",
      quantile: "Quantile pr√©dit",
    },
    weather: {
      title: "Pr√©visions M√©t√©orologiques",
      variable: "Variable:",
      days: "Jours:",
    },
    common: {
      loading: "Chargement",
      previousDay: "Jour pr√©c√©dent",
      nextDay: "Jour suivant",
      today: "Aujourd'hui",
      close: "Fermer",
    },
    species: {
      "Common Buzzard": "Buse variable",
      "Red Kite": "Milan royal",
      "Black Kite": "Milan noir",
      "European Honey-buzzard": "Bondr√©e apivore",
      "Western Marsh Harrier": "Busard des roseaux",
      "Eurasian Sparrowhawk": "√âpervier d'Europe",
      "Eurasian Kestrel": "Faucon cr√©cerelle",
      "Osprey": "Balbuzard p√™cheur",
      "Hen Harrier": "Busard Saint-Martin",
      "Merlin": "Faucon √©merillon",
      "Eurasian Hobby": "Faucon hobereau",
    },
  },
  de: {
    nav: {
      title: "Defile Vogelprognosen",
      settings: "Einstellungen",
    },
    intro: {
      title: "Willkommen bei Defile Vogelprognosen",
      description:
        "Diese Website bietet t√§gliche Migrationsprognosen f√ºr die Z√§hlung von Greifvogelarten am D√©fil√© de l'Ecluse, basierend auf einem",
      neuralNetwork: "neuronalen Netzwerkmodell",
      checkActualCount: "Schauen Sie sich die tats√§chliche Z√§hlung an auf",
      readMore:
        "und lesen Sie mehr √ºber die Geschichte dieses Projekts (auf Franz√∂sisch) auf der Website von",
    },
    table: {
      title: "Heutige Vorhersagen nach Art",
      species: "Arten",
      observed: "Beobachtet",
      counted: "Gez√§hlt",
      predicted: "Vorhergesagt",
      historical: "Historischer Median",
      quantile: "Quantil",
      explanation: {
        title: "Tabellenspalten erkl√§rt",
        species: "Vogelartname",
        observed: "Bisher beobachtete Gesamtzahl der Art (Live-Daten falls verf√ºgbar)",
        predicted: "Vorhergesagte Gesamtzahl der erwarteten Individuen der Art (von 6 bis 19 Uhr)",
        quantile:
          "Wie sich die Vorhersage der Art im Vergleich zu vergangenen Jahren verh√§lt (z.B. 90. bedeutet h√∂her als 90% der Vorjahre f√ºr dieses Datum)",
        historicalMedian: "Typische (mediane) Z√§hlung f√ºr dieses Datum in vergangenen Jahren",
      },
    },
    plots: {
      hourlyPrediction: "St√ºndliche Vorhersage",
      expandAll: "Alle Erweitern",
      collapseAll: "Alle Einklappen",
      today: "Heute",
      nextDays: "N√§chste Tage",
      season: "Diese Saison...",
      species: "Arten",
      noForecastData: "Keine Prognosedaten verf√ºgbar",
      predictedTotal: "Vorhergesagt Gesamt",
      observedTotal: "Beobachtet Gesamt",
      quantileRange: "Quantil 20-80%",
      median: "Median",
      dailyCount: "T√§gliche Anzahl",
      date: "Datum",
      hour: "Stunde",
      forecast: "Vorhersage",
      trektellenObservations: "Trektellen Beobachtungen",
      forecastedCounts: "Vorhergesagte Einzelzahlen (#)",
      historicalCounts: "Historische Zahlen (#)",
      birds: "V√∂gel",
      futureDays: "Zuk√ºnftige Tage (st√ºndliche Abfolge)",
      hourlyForecastCount: "St√ºndliche Vorhersagezahl",
    },
    settings: {
      title: "Einstellungen",
      plotsToDisplay: "Anzuzeigende Diagramme",
      today: "Heute",
      nextDays: "N√§chste Tage",
      season: "Saison",
      threshold: "Historischer Median-Z√§hlschwellwert",
      thresholdHelp:
        "Nur Arten mit einer h√∂heren historischen medianen Tagesz√§hlung f√ºr den Tag werden angezeigt",
      nextDaysCount: "Anzahl der n√§chsten anzuzeigenden Tage",
      nextDaysHelp:
        'Anzahl der Tage nach heute, die in der "N√§chste Tage"-Prognose angezeigt werden sollen',
      sortBy: "Arten sortieren nach",
      taxonomy: "Taxonomie",
      median: "Medianz√§hlung",
      predicted: "Vorhergesagte Z√§hlung",
      quantile: "Vorhergesagtes Quantil",
    },
    weather: {
      title: "Wettervorhersage",
      variable: "Variable:",
      days: "Tage:",
    },
    common: {
      loading: "Laden",
      previousDay: "Vorheriger Tag",
      nextDay: "N√§chster Tag",
      today: "Heute",
      close: "Schlie√üen",
    },
    species: {
      "Common Buzzard": "M√§usebussard",
      "Red Kite": "Rotmilan",
      "Black Kite": "Schwarzmilan",
      "European Honey-buzzard": "Wespenbussard",
      "Western Marsh Harrier": "Rohrweihe",
      "Eurasian Sparrowhawk": "Sperber",
      "Eurasian Kestrel": "Turmfalke",
      "Osprey": "Fischadler",
      "Hen Harrier": "Kornweihe",
      "Merlin": "Merlin",
      "Eurasian Hobby": "Baumfalke",
    },
  },
};

/**
 * Initialize locale using URL parameters, localStorage, and browser APIs
 * @returns {string} - The initialized locale (en, fr, de)
 */
const initializeLocale = () => {
  const supportedLocales = LANGUAGE_OPTIONS.map((lang) => lang.code);
  let initialLocale = "en";

  // Check if running in browser environment
  if (typeof window !== "undefined") {
    // 1. Try URL parameter first (highest priority)
    try {
      const urlParams = new URLSearchParams(window.location.search);
      const urlLocale = urlParams.get("lang");
      if (urlLocale && supportedLocales.includes(urlLocale)) {
        console.log("Using URL parameter locale:", urlLocale);
        initialLocale = urlLocale;
        // Save to localStorage for future visits
        localStorage.setItem("defile-locale", urlLocale);
        return initialLocale;
      }
    } catch (error) {
      console.warn("Error reading URL parameters:", error);
    }

    // 2. Try localStorage next
    try {
      const savedLocale = localStorage.getItem("defile-locale");
      if (savedLocale && supportedLocales.includes(savedLocale)) {
        console.log("Using saved locale:", savedLocale);
        initialLocale = savedLocale;
      } else {
        // 3. Use modern Intl API for better browser language detection
        const browserLocale = Intl.DateTimeFormat().resolvedOptions().locale.split("-")[0];
        if (supportedLocales.includes(browserLocale)) {
          console.log("Using Intl detected locale:", browserLocale);
          initialLocale = browserLocale;
        } else {
          // 4. Fallback to navigator.language
          const navLang = navigator.language?.split("-")[0];
          if (navLang && supportedLocales.includes(navLang)) {
            console.log("Using navigator language:", navLang);
            initialLocale = navLang;
          } else {
            console.log("No supported language found, using English fallback");
          }
        }
      }
    } catch (error) {
      console.warn("Error during locale detection:", error);
      // Even simpler fallback - just use English
      initialLocale = "en";
    }
  } else {
    console.log("SSR environment, using English fallback");
  }

  console.log("Initializing locale to:", initialLocale);
  return initialLocale;
};

// Initialize the locale immediately
const initialLocale = initializeLocale();

// Create i18n instance with the detected locale
const i18n = createI18n({
  locale: initialLocale,
  fallbackLocale: "en",
  messages,
  legacy: false, // Use Composition API mode
});

/**
 * Update locale and save to localStorage
 * @param {string} newLocale - The new locale to set
 */
export const updateLocale = (newLocale) => {
  const supportedLocales = LANGUAGE_OPTIONS.map((lang) => lang.code);
  if (supportedLocales.includes(newLocale)) {
    i18n.global.locale.value = newLocale;
    if (typeof window !== "undefined") {
      localStorage.setItem("defile-locale", newLocale);
    }
    console.log("Updated locale to:", newLocale);
  } else {
    console.warn("Unsupported locale:", newLocale);
  }
};

export default i18n;
